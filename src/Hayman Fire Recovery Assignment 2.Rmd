---
title: "Hayman Fire Recovery"
author: "Sam Leuthold"
date: "1/31/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, warning=F,message=F}
library(tidyverse)
library(tidyr)
library(ggthemes)
library(lubridate)
library(ggsci)

# Now that we have learned how to munge (manipulate) data
# and plot it, we will work on using these skills in new ways

knitr::opts_knit$set(root.dir='..')
```


```{r dataread, warning=F,message=F}

#Reading in files
files <- list.files('./data',full.names=T)


#Read in individual data files
ndmi <- read_csv(files[1]) %>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndmi')


ndsi <- read_csv(files[2]) %>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndsi')

ndvi <- read_csv(files[3])%>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndvi')

# Stack as a tidy dataset
full_long <- rbind(ndvi,ndmi,ndsi) %>%
  gather(key='site',value='value',-DateTime,-data) %>%
  filter(!is.na(value))


head(full_long)

```




## Question 1) 

What is the correlation between NDVI and NDMI? - here I want you to
convert the full_long dataset in to a wide dataset using the 
function "spread" and then make a plot that shows the correlation s a
function of if the site was burned or not (x axis should be ndmi)
You should exclude winter months and focus on summer months

```{r, warning=F,message=F}

Q1.data <- full_long %>%
           filter(!is.na(value)) %>%
           pivot_wider(names_from = c(data),
                       values_from = c(value)) %>% 
           mutate(month = month(DateTime)) %>%
           filter(month %in% c(6,7,8,9))
           

ggplot(data = Q1.data, aes(x = ndmi, y = ndvi)) +
  geom_point(aes(fill = month), shape = 21, size = 3) +
  geom_smooth(method = "lm") +
  facet_grid(.~site) +
  xlab("NDMI") +
  ylab("NDVI") +
  theme_classic()

```

## Question 2 

2) What is the correlation between average NDSI (normalized
 snow index) for January - April and average NDVI for June-August?
In other words, does the previous year's snow cover influence vegetation
 growth for the following summer?

```{r, warning=F,message=F}

Q2.data.winter <- full_long %>%
                    filter(!is.na(value)) %>%
                    pivot_wider(names_from = c(data),
                                values_from = c(value)) %>% 
                    mutate(Year = year(DateTime), 
                           Month = month(DateTime)) %>%
                    filter(Month %in% c(1, 2, 3, 4)) %>%
                    group_by(site, Year) %>%
                    summarise(Mean_Winter_NDSI = mean(ndsi)) 

Q2.data.summer <- full_long %>%
                    filter(!is.na(value)) %>%
                    pivot_wider(names_from = c(data),
                                values_from = c(value)) %>% 
                    mutate(Year = year(DateTime), 
                           Month = month(DateTime)) %>%
                    filter(Month %in% c(6, 7, 8)) %>%
                    group_by(site, Year) %>%
                    summarise(Mean_Summer_NDVI = mean(ndvi)) 


Q2.data <-  inner_join(Q2.data.summer,
                       Q2.data.winter)

cor(Q2.data$Mean_Summer_NDVI,
    Q2.data$Mean_Winter_NDSI,
    use = "complete.obs")

summary(lm(Mean_Winter_NDSI ~ Mean_Summer_NDVI, data = Q2.data))

ggplot(data = Q2.data, aes(x = Mean_Winter_NDSI, y = Mean_Summer_NDVI)) +
  geom_point() +
 # facet_grid(.~site) +
  geom_smooth(method = "lm")

```


## Q3

How is the snow effect from question 2 different between pre- and post-burn
and burned and unburned? 

```{r, warning=F,message=F}

Q3.data <-  Q2.data %>% 
              mutate(Status = if_else(Year < 2002, "Pre-Burn", "Post-Burn"))

ggplot(data = Q3.data, aes(x = Mean_Winter_NDSI, y = Mean_Summer_NDVI)) +
  geom_point() +
  facet_grid(Status~site) +
  geom_smooth(method = "lm")


```
## Question 4

What month is the greenest month on average? 

```{r}

 full_long %>%
  filter(!is.na(value)) %>%
  pivot_wider(names_from = c(data),
              values_from = c(value)) %>% 
              mutate(Year = year(DateTime), 
                     Month = month(DateTime)) %>%
   group_by(Month) %>% 
   summarise(Mean_NDVI = mean(ndvi, na.rm = T)) %>% 
   filter(Mean_NDVI == max(Mean_NDVI))

```


## Question 5) 

What month is the snowiest on average?

```{r}

 full_long %>%
  filter(!is.na(value)) %>%
  pivot_wider(names_from = c(data),
              values_from = c(value)) %>% 
              mutate(Year = year(DateTime), 
                     Month = month(DateTime)) %>%
   group_by(Month) %>% 
   summarise(Mean_NDSI = mean(ndsi, na.rm = T)) %>% 
   filter(Mean_NDSI == max(Mean_NDSI))

```


## Bonus Question: Redo all problems with `spread` and `gather` using modern tidyverse syntax. 


## Bonus Question: Use Climage Engine to pull the same data for the assignment, but updated with 2020/2021 data.




